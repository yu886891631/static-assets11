# EJS 实战指南

> **适用场景：** SillyTavern + EJS扩展 + MVU变量框架  
> **整理：** 秋青子  
> **更新日期：** 2025年10月20日  
> **版本：** v3.0

---

## 📌 阅读须知

### 本指南的特点

- ✅ 所有示例均经过实战验证
- ✅ 明确区分 **EJS官方功能** 与 **MVU框架功能**
- ✅ 包含完整的调试方法和常见错误解决方案
- ✅ 提供大量真实案例参考

### 适合人群

- 正在使用 SillyTavern 做角色卡的创作者
- 需要实现复杂动态内容的开发者
- 希望掌握 EJS + MVU 最佳实践的学习者

---

## 一、基础语法

### 1.1 标签类型

| 标签           | 作用             | 说明                 |
| -------------- | ---------------- | -------------------- |
| `<% 代码 %>`   | 执行代码         | 不输出内容，有空白行 |
| `<%_ 代码 _%>` | 执行代码（推荐） | 不输出内容，去除空白 |
| `<%= 变量 %>`  | 输出变量         | HTML转义，安全输出   |
| `<%- 变量 %>`  | 输出变量（推荐） | 不转义，原样输出     |
| `<%# 注释 %>`  | EJS注释          | 不会被处理           |

**最佳实践：**

```javascript
<%_ 
// ✅ 使用 <%_ _%> 避免多余换行
const value = 100;
_%>

<%- output %>           ✅ 使用 <%- 输出内容
<%# 这是注释 %>         ✅ 使用 <%# 写注释

<% print(value) %>     ❌ 不推荐使用 print()
<% // 普通注释 %>       ❌ 不推荐用 JS 注释
```

### 1.2 混合渲染示例

EJS 可以在同一文件中混合代码逻辑和文本输出：

```javascript
<%_ 
const name = '夏莉';
const level = 5;
_%>

## 角色信息
**姓名**: <%= name %>
**等级**: <%= level %>

<% if (level > 3) { %>
这是高级角色！
<% } %>
```

**渲染结果：**

```markdown
## 角色信息
**姓名**: 夏莉
**等级**: 5

这是高级角色！
```

---

## 二、变量系统

### 2.1 变量作用域（EJS官方）

#### variables 对象

EJS 提供了一个全局的 `variables` 对象，包含所有合并后的变量：

```javascript
variables = {}  // 按优先级合并的所有变量
```

#### 作用域类型

| 作用域    | 说明     | 持久化 | 使用场景             |
| --------- | -------- | ------ | -------------------- |
| `global`  | 全局变量 | ✅      | 跨角色、跨对话共享   |
| `local`   | 聊天变量 | ✅      | 当前聊天记录         |
| `message` | 消息变量 | ✅      | 绑定到具体消息       |
| `cache`   | 临时变量 | ❌      | 临时计算（默认）     |
| `initial` | 初始变量 | ❌      | 只读，来自 [InitVar] |

#### 优先级顺序

当多个作用域有同名变量时，按以下顺序合并（从高到低）：

1. 消息变量（从最新到最旧）
2. 局部变量
3. 全局变量

### 2.2 MVU框架变量（⚠️ 重要）

`stat_data` **不是 EJS 官方功能**，而是 **MVU变量管理框架** 的数据结构。

#### 存储格式

MVU 将数据存储在 `local` 作用域的 `stat_data` 对象中：

```javascript
{
  "stat_data": {
    "角色名": {
      "属性名": [值, "说明"]  // [0]是值，[1]是说明
    }
  }
}
```

#### 读取规则（EJS中）

```javascript
// ✅ 正确写法
const value = getvar('stat_data.角色.属性[0]') || 默认值;

// ❌ 常见错误
const value = getvar('角色.属性[0]');         // 缺少 stat_data 前缀
const value = getvar('stat_data.角色.属性');  // 缺少 [0] 索引
```

**核心要点：**

- **必须**包含 `stat_data.` 前缀
- **必须**使用 `[0]` 访问值（`[1]` 是说明文本）

### 2.3 变量操作函数（EJS官方）

#### getvar() - 读取变量

**语法：**

```javascript
getvar(key, options)
```

**参数：**

- `key`：变量路径（字符串）
- `options`：可选配置对象
  - `scope`：指定作用域（`'global'`、`'local'`、`'message'`、`'cache'`、`'initial'`）
  - `defaults`：默认值
  - `noCache`：禁用缓存（用于读取刚设置的变量）

**示例：**

```javascript
<%_
// 读取 MVU 变量
const aoValue = getvar('stat_data.傲娇系统.傲[0]') || 100;

// 指定作用域和默认值
const userName = getvar('用户名', { scope: 'local', defaults: '未知' });

// 禁用缓存
setvar('temp', 999);
const temp = getvar('temp', { noCache: true });
_%>
```

---

#### setvar() - 设置变量

**语法：**

```javascript
setvar(key, value, options)
```

**参数：**

- `key`：变量名
- `value`：变量值
- `options`：可选配置对象
  - `scope`：作用域（默认 `'message'`）
  - `flags`：设置标志（见下表）

**Flags 标志：**

| 标志  | 说明                            |
| ----- | ------------------------------- |
| `n`   | 直接设置（默认）                |
| `nx`  | 不存在时才设置（基于cache）     |
| `xx`  | 存在时才设置（基于cache）       |
| `nxs` | 不存在时才设置（基于指定scope） |
| `xxs` | 存在时才设置（基于指定scope）   |

**示例：**

```javascript
<%_
// 设置到 local 作用域
setvar('计数器', 1, { scope: 'local' });

// 仅当变量不存在时设置
setvar('初始化标记', true, { scope: 'local', flags: 'nx' });
_%>
```

---

#### incvar() / decvar() - 增减变量

**语法：**

```javascript
incvar(key, value, options)  // 增加
decvar(key, value, options)  // 减少
```

**参数：**

- `key`：变量路径
- `value`：变化量
- `options`：可选配置对象
  - `scope`：作用域
  - `min`：最小值限制
  - `max`：最大值限制

**示例：**

```javascript
<%_
// 好感度 +5，限制在 [0, 100]
incvar('好感度', 5, { scope: 'local', min: 0, max: 100 });

// 金币 -100，不低于 0
decvar('金币', 100, { scope: 'local', min: 0 });
_%>
```

---

## 三、世界书操作

### 3.1 getwi() - 读取条目

**语法：**

```javascript
getwi(lorebook, title, data)
getwi(title, data)              // 自动推断世界书
```

**参数：**

- `lorebook`：世界书名（`null` 表示当前世界书）
- `title`：条目标题或 UID
- `data`：传递给条目的数据（可选）

**基础示例：**

```javascript
<%_
const progress = getvar('stat_data.训练.进度[0]') || 0;
_%>

<% if (progress < 25) { %>
  <%- await getwi(null, '阶段01_初期') %>
<% } else if (progress < 50) { %>
  <%- await getwi(null, '阶段02_中期') %>
<% } else if (progress < 75) { %>
  <%- await getwi(null, '阶段03_后期') %>
<% } else { %>
  <%- await getwi(null, '阶段04_完成') %>
<% } %>
```

**动态拼接条目名：**

```javascript
<%_
const characterName = getvar('stat_data.目标.姓名[0]') || '未知';
_%>

<%- await getwi(null, `角色_${characterName}_档案`) %>
```

---

### 3.2 activewi() - 激活条目

**语法：**

```javascript
activewi(lorebook, title, force)
activewi(title, force)              // 自动推断世界书
```

**参数：**

- `lorebook`：世界书名（`null` 表示当前世界书）
- `title`：条目标题
- `force`：强制激活（忽略关键词检测）

**⚠️ 使用限制：**

必须在 `[GENERATE:BEFORE]` 或 `@@generate_before` 装饰器的条目中使用。

**示例：**

```javascript
// 条目标题：[GENERATE:BEFORE] 事件激活器
<%_
const activeEvents = getvar('stat_data.系统.激活事件[0]') || [];
for (const eventName of activeEvents) {
  await activewi(null, eventName, true);
}
_%>
```

---

## 四、多阶段人设系统

### 4.1 设计思路

**目的：** 根据变量动态加载不同的角色设定，实现角色成长和关系变化。

**结构：**

```
世界书/
├── 角色_控制器 (✅启用，设置关键词)
├── 角色_阶段01   (❌禁用)
├── 角色_阶段02   (❌禁用)
├── 角色_阶段03   (❌禁用)
└── ...
```

- **控制器条目**：启用并设置关键词，负责读取变量并调用对应阶段
- **阶段条目**：禁用，由控制器通过 `getwi()` 动态加载

---

### 4.2 控制器模板

```javascript
<%_
// 读取变量
const progress = getvar('stat_data.角色.进度[0]') || 0;
const relation = getvar('stat_data.角色.关系[0]') || '陌生';
_%>

<%# 优先判断关系状态 %>
<% if (relation === '恋人') { %>
  <%- await getwi(null, '角色_恋人阶段') %>
<% } else if (relation === '朋友') { %>
  <%- await getwi(null, '角色_朋友阶段') %>
<% } else { %>
  <%# 根据进度细分阶段 %>
  <% if (progress < 25) { %>
    <%- await getwi(null, '角色_阶段01') %>
  <% } else if (progress < 50) { %>
    <%- await getwi(null, '角色_阶段02') %>
  <% } else if (progress < 75) { %>
    <%- await getwi(null, '角色_阶段03') %>
  <% } else { %>
    <%- await getwi(null, '角色_阶段04') %>
  <% } %>
<% } %>
```

---

### 4.3 实战案例：夏莉傲娇系统

```javascript
<%_
// 读取变量
const aoValue = getvar('stat_data.傲娇系统.傲[0]') || 100;
const relation = getvar('stat_data.世界信息.关系状态[0]') || '同学';
_%>

<%# 关系状态优先于傲值 %>
<% if (relation === '老婆') { %>
  <%- await getwi(null, '夏莉_阶段12_老婆') %>
<% } else if (relation === '女友') { %>
  <%- await getwi(null, '夏莉_阶段11_女友') %>
<% } else if (aoValue > 90) { %>
  <%- await getwi(null, '夏莉_阶段01_极度傲娇') %>
<% } else if (aoValue > 80) { %>
  <%- await getwi(null, '夏莉_阶段02_傲娇壁垒') %>
<% } else if (aoValue > 70) { %>
  <%- await getwi(null, '夏莉_阶段03_傲娇松动') %>
<% } else if (aoValue > 60) { %>
  <%- await getwi(null, '夏莉_阶段04_开始动摇') %>
<% } else if (aoValue > 50) { %>
  <%- await getwi(null, '夏莉_阶段05_情感觉醒') %>
<% } else if (aoValue > 40) { %>
  <%- await getwi(null, '夏莉_阶段06_等待期') %>
<% } else if (aoValue > 30) { %>
  <%- await getwi(null, '夏莉_阶段07_催促期') %>
<% } else if (aoValue > 20) { %>
  <%- await getwi(null, '夏莉_阶段08_忍耐极限') %>
<% } else if (aoValue > 10) { %>
  <%- await getwi(null, '夏莉_阶段09_表白决心') %>
<% } else if (aoValue >= 1) { %>
  <%- await getwi(null, '夏莉_阶段10_表白进行时') %>
<% } else if (aoValue === 0) { %>
*夏莉最近总是欲言又止，眼神里藏着什么想说又不敢说的话...*
<% } %>
```

---

## 五、内容注入

### 5.1 标题前缀

在条目**标题**中添加特殊前缀，控制注入位置：

| 前缀                  | 注入位置     | 说明           |
| --------------------- | ------------ | -------------- |
| `[GENERATE:BEFORE]`   | LLM提示开头  | 在所有内容之前 |
| `[GENERATE:AFTER]`    | LLM提示末尾  | 在所有内容之后 |
| `[GENERATE:0:BEFORE]` | 第0条消息前  | 特定位置注入   |
| `[RENDER:BEFORE]`     | 渲染消息开头 | 显示用         |
| `[RENDER:AFTER]`      | 渲染消息末尾 | 显示用         |
| `[InitialVariables]`  | 初始变量     | 必须是标准JSON |

**示例：**

```
条目标题：[GENERATE:BEFORE] 夏莉_控制器
条目状态：✅ 启用
```

---

### 5.2 装饰器

在条目**内容开头**添加装饰器，效果同标题前缀：

| 装饰器                | 等价于               | 说明                   |
| --------------------- | -------------------- | ---------------------- |
| `@@generate_before`   | `[GENERATE:BEFORE]`  | 注入到提示开头         |
| `@@generate_after`    | `[GENERATE:AFTER]`   | 注入到提示末尾         |
| `@@render_before`     | `[RENDER:BEFORE]`    | 渲染到消息开头         |
| `@@render_after`      | `[RENDER:AFTER]`     | 渲染到消息末尾         |
| `@@preprocessing`     | -                    | 预处理（世界书前执行） |
| `@@activate`          | -                    | 视为🔵永久激活          |
| `@@always_enabled`    | -                    | 强制启用特殊条目       |
| `@@initial_variables` | `[InitialVariables]` | 初始变量               |

**规则：**

- 必须在内容最开头
- 每行一个装饰器
- 多个装饰器间不能有空行

**⚠️ 装饰器使用规则**

#### 互斥关系

- `@@preprocessing` 与 `@@generate_before`/`@@generate_after` **不要同时使用**
- 同时使用时，`@@preprocessing` 会被忽略
- 原因：`@@generate_*` 会直接修改提示词位置，跳过世界书逻辑

#### 重复规则

- 重复的装饰器只生效一次（不会报错）
- 例如：写两次 `@@generate_before` 只会执行一次

#### 可以组合

- `@@generate_before` 和 `@@generate_after` **可以同时使用**
- 分别控制开头和结尾的注入

**示例：**

```javascript
// ✅ 正确
@@generate_before
<%_ // 注入到提示开头 _%>
```

```javascript
// ✅ 正确：同时控制开头和结尾
@@generate_before
@@generate_after
<%_ // 同时注入到开头和结尾 _%>
```

```javascript
// ❌ 错误：互斥装饰器
@@preprocessing
@@generate_before
<%_ // preprocessing 被忽略 _%>
```

---

### 5.3 `@@preprocessing` 实战应用

**用途：** 在世界书处理前执行代码，动态生成关键词，按需激活其他条目。

**场景：** 节省Token，只在特定条件下激活大型内容。

**版本要求：** SillyTavern 1.13.4+

---

#### 案例：动态活动系统

**目标：** 只在特定日期激活对应活动，不浪费Token扫描所有活动。

**架构：**

```
控制器 (@@preprocessing, 🔵永久激活)
  ↓ 根据日期输出关键词
学园祭 (🟢关键词: "学园祭活动", ❌禁用)
运动会 (🟢关键词: "运动会活动", ❌禁用)
修学旅行 (🟢关键词: "修学旅行活动", ❌禁用)
```

**步骤1：创建控制器**

```javascript
// 条目名称：活动控制器
// 条目设置：🔵永久激活，❌无关键词

@@preprocessing
<%_
const date = getvar('stat_data.世界信息.当前日期[0]') || '';
_%>

<%_ if (date.includes('10月25日') || date.includes('10月27日') || date.includes('10月28日')) { _%>
学园祭活动
<%_ } else if (date.includes('11月8日') || date.includes('11月11日')) { _%>
运动会活动
<%_ } else if (date.includes('12月9日') || date.includes('12月10日') || date.includes('12月11日')) { _%>
修学旅行活动
<%_ } _%>
```

**步骤2：创建活动条目**

```yaml
# 条目名称：学园祭
# 条目设置：🟢关键词「学园祭活动」，❌禁用，❌不用@@preprocessing

活动名称: 学园祭
活动时间: 10月25日、27日、28日
活动背景: 江海市第一中学年度学园祭...
活动内容: ...（大量详情）...
```

**执行流程：**

1. **预处理阶段**：控制器执行，检查日期，输出关键词（如「学园祭活动」）
2. **世界书阶段**：SillyTavern 检测到关键词，激活对应条目
3. **结果**：只激活当天的活动，其他活动完全不扫描

**对比其他方案：**

| 方案              | 优点              | 缺点                    |
| ----------------- | ----------------- | ----------------------- |
| ✅ 控制器 + 关键词 | Token少，维护方便 | 需要 ST 1.13.4+         |
| ❌ 每个活动都判断  | 兼容性好          | Token浪费，每个都要执行 |

**注意事项：**

1. 控制器必须 🔵永久激活
2. 关键词必须完全匹配
3. 输出文本要简短（会进入提示词）

---

### 5.4 特殊装饰器说明

#### `@@always_enabled`

用于 `[GENERATE]`、`[RENDER]`、`[INJECT]` 等特殊条目，强制启用该条目。

**使用场景：** 当SillyTavern设置中开启了"GENERATE/RENDER/INJECT条目禁用视为启用"选项时，需要使用此装饰器来保持条目启用状态。

```javascript
@@always_enabled
@@generate_before
<%_ // 强制启用的代码 _%>
```

---

### 5.5 @INJECT 消息注入（高级功能）

**⚠️ 重要：**

- 条目必须**禁用❌**才会生效
- 如果SillyTavern开启了"GENERATE/RENDER/INJECT条目禁用视为启用"选项，则需要**启用✅**

**语法：**

```
@INJECT pos=1,role=system                    // 在第1条消息插入
@INJECT target=user,index=-1,role=system     // 在最后一条用户消息前插入
@INJECT regex=紧急,role=system               // 匹配关键词时插入
```

---

## 六、调试技巧

### 6.1 控制台输出（推荐）

```javascript
<%_
const value = getvar('stat_data.角色.属性[0]') || 0;

console.log('普通日志:', value);
console.info('信息:', value);        // 蓝色
console.warn('警告:', value);        // 黄色
console.error('错误:', value);       // 红色
_%>
```

**查看方式：** 按 `F12` → Console 标签

---

### 6.2 页面通知

```javascript
<%_
toastr.info('信息');                 // 右上角通知
toastr.success('成功');
toastr.warning('警告');
toastr.error('错误');
_%>
```

---

### 6.3 断点调试

**最强大的调试方式：** 使用 `debugger;` 暂停代码执行。

```javascript
<%_
const aoValue = getvar('stat_data.傲娇系统.傲[0]') || 100;

debugger;  // 暂停，查看所有变量

if (aoValue > 90) {
  // ...
}
_%>
```

**步骤：**

1. 按 `F12` 打开开发者工具
2. 切换到 **Sources** 标签
3. 执行到 `debugger;` 会暂停
4. 查看变量、逐步执行、实时修改

**优势：**

- 查看完整变量结构
- 逐步执行代码
- 实时修改变量测试

---

### 6.4 混合输出

```javascript
<%_
const aoValue = getvar('stat_data.傲娇系统.傲[0]') || 100;
console.info('调试 - 傲值:', aoValue);
console.info('调试 - 类型:', typeof aoValue);
_%>

当前傲值: <%= aoValue %>
```

---

## 七、常见错误

### 7.1 变量读取错误

| 错误                                 | 原因                           | 解决方案                           |
| ------------------------------------ | ------------------------------ | ---------------------------------- |
| `getvar('角色.属性[0]')`             | 缺少 `stat_data` 前缀          | `getvar('stat_data.角色.属性[0]')` |
| `getvar('stat_data.角色.属性')`      | 缺少 `[0]` 索引                | `getvar('stat_data.角色.属性[0]')` |
| `getvar('变量', { scope: 'local' })` | MVU变量自动在local，不需要指定 | `getvar('stat_data.变量[0]')`      |

---

### 7.2 条目不执行

**可能原因：**

1. 条目是禁用状态（控制器必须启用✅）
2. 没有设置关键词或🔵永久激活
3. 装饰器格式错误（中间有空行）
4. 使用了特殊装饰器（如 `@@always_enabled`），但SillyTavern开启了"GENERATE/RENDER/INJECT条目禁用视为启用"选项

**调试方法：**

```javascript
<%_
console.info('=== 条目已执行 ===');
const value = getvar('stat_data.角色.属性[0]') || 0;
console.info('读取值:', value);
_%>
```

---

### 7.3 getwi() 调用错误

| 错误                           | 正确                                 |
| ------------------------------ | ------------------------------------ |
| `print(await getwi('条目名'))` | `<%- await getwi(null, '条目名') %>` |
| `await getwi('条目名')`        | `<%- await getwi(null, '条目名') %>` |

---

### 7.4 变量重复声明

**问题：** 多个条目使用 `const` 声明同名变量会报错。

**解决方案：**

```javascript
// ✅ 方案1：条件声明（推荐）
if (typeof affection === 'undefined') {
  var affection = getvar('stat_data.角色.好感[0]') || 0;
}

// ✅ 方案2：使用唯一变量名
const xialiAffection = getvar('stat_data.夏莉.好感[0]') || 0;
```

---

## 八、最佳实践

### 8.1 代码风格

```javascript
// ✅ 推荐
<%_
const value = getvar('stat_data.角色.属性[0]') || 0;
_%>

<% if (value > 50) { %>
<%- await getwi(null, '条目名') %>
<% } %>

// ❌ 不推荐
<%
const value = getvar('stat_data.角色.属性[0]') || 0;
if (value > 50) {
  print(await getwi('条目名'));  // 不推荐 print()
}
%>
```

---

### 8.2 变量命名

```javascript
// ✅ 使用有意义的名字
const aoValue = getvar('stat_data.傲娇系统.傲[0]') || 100;
const relationStatus = getvar('stat_data.世界信息.关系状态[0]') || '同学';

// ❌ 避免单字母变量
const a = getvar('stat_data.傲娇系统.傲[0]') || 100;
```

---

### 8.3 避免重复声明

**问题：** 多个条目同时执行时，`const`/`let` 声明同名变量会报错。

**解决方案（推荐）：**

```javascript
// 使用 typeof 检查
if (typeof xialiAo === 'undefined') {
  var xialiAo = getvar('stat_data.傲娇系统.傲[0]') || 100;
}
```

**优点：**

- 避免重复声明冲突
- 多个条目共享变量
- 减少 `getvar()` 调用次数

---

### 8.4 错误处理

```javascript
<%_
const value = getvar('stat_data.角色.属性[0]');
if (value === null || value === undefined) {
  console.warn('变量不存在，使用默认值');
  value = 0;
}
_%>
```

---

## 九、参考资源

### 9.1 官方文档

- **EJS语法参考**: <https://ejs.co/>
- **SillyTavern EJS扩展**: [features_cn.md](./features_cn.md)
- **API完整参考**: [reference_cn.md](./reference_cn.md)

### 9.2 常用函数速查

```javascript
// 变量操作
getvar(key, options)
setvar(key, value, options)
incvar(key, value, options)
decvar(key, value, options)

// 世界书操作
getwi(lorebook, title, data)
activewi(lorebook, title, force)

// 内置库
_          // Lodash
faker      // Faker
$          // jQuery
toastr     // 通知
```

### 9.3 内置变量

```javascript
variables       // 合并后的所有变量
runType         // 'generate'|'preparation'|'render'
userName        // 用户名
charName        // 角色名
chatId          // 聊天ID
charLoreBook    // 角色世界书名
userLoreBook    // 用户世界书名
chatLoreBook    // 聊天世界书名
```

---

## 十、更新日志

### v3.0 (2025-10-20)

- ✅ 全面优化文档结构，提升可读性
- ✅ 精简冗余内容，保留核心知识点
- ✅ 统一格式和术语使用
- ✅ 优化示例代码，更清晰易懂

### v2.0 (2025-10-20)

- ✅ 修正装饰器互斥关系说明
- ✅ 新增 `@@preprocessing` 实战应用
- ✅ 新增 `debugger;` 断点调试技巧
- ✅ 提供动态激活条目完整案例

### v1.0 (2025-10-20)

- ✅ 修正 `stat_data` 路径的错误理解
- ✅ 明确区分 EJS 官方功能 vs MVU 框架
- ✅ 所有示例经过实战验证
- ✅ 新增调试技巧和常见错误解决方案

---

**整理者：秋青子**  
适用场景：SillyTavern + EJS扩展 + MVU变量框架  
祝哥哥创作顺利！📝
