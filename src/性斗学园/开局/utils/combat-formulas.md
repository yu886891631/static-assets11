# 战斗数值计算公式文档

本文档定义了PVE回合制战斗系统的所有数值计算公式和变量关系。

## 核心数值定义

### 等级 (Level)
- **范围**: 1-100
- **作用**: 衡量角色性斗经验与综合实力的核心指标
- **影响**: 
  - 是计算性斗力与忍耐力的基础
  - 是解锁特定事件与装备的前提

### 潜力 (Potential)
- **范围**: 5.0-10.0
- **作用**: 决定角色成长上限与天赋的隐藏数值
- **影响**: 
  - 潜力越高，每次升级带来的属性点越多
  - 直接影响性斗力的成长基数


## 核心计算公式

### 性斗力 (Sexual Combat Power)

**公式**:
```
性斗力 = ((等级 × 潜力) + 装备基础性斗力加成 + 状态基础性斗力加成) × (1 + (装备基础性斗力成算 + 状态基础性斗力成算)/100)
```

**说明**:
- 基础值 = 等级 × 潜力
- 加成包括：装备加成、永久状态加成、临时状态加成
- 成算为百分比加成，例如 30% = 1.3 倍
- 贤者时间（高潮后3回合）：性斗力 -20%

**示例**:
- 等级10，潜力6.0，装备加成+5，永久状态加成+3，成算+30%
- 基础值 = 10 × 6.0 = 60
- 加成总和 = 60 + 5 + 3 = 68
- 最终性斗力 = 68 × 1.3 = 88.4 ≈ 88

### 忍耐力 (Endurance)

**公式**:
```
忍耐力 = ((等级 × 潜力/2) + 装备基础忍耐力加成 + 状态基础忍耐力加成) × (1 + (装备基础忍耐力成算 + 状态基础忍耐力成算)/100)
```

**说明**:
- 基础值 = 等级 × (潜力 ÷ 2)
- 加成包括：装备加成、永久状态加成、临时状态加成
- 成算为百分比加成
- 贤者时间（高潮后3回合）：忍耐力 +10%
- 虚脱状态（达到高潮次数上限）：当前耐力 -30%

**示例**:
- 等级10，潜力6.0，装备加成+8，永久状态加成+5，成算+20%
- 基础值 = 10 × (6.0/2) = 30
- 加成总和 = 30 + 8 + 5 = 43
- 最终忍耐力 = 43 × 1.2 = 51.6 ≈ 51

## 快感与高潮系统

### 快感 (Lust)
- **上限**: 等于变量中的 `_最大快感`（不是固定值）
- **效果**: 达到最大快感值时强制高潮
- **高潮后**: 
  - 快感值清空为0
  - 进入"贤者时间"状态（持续3回合）
  - 性斗力 -20%，忍耐力 +10%
  - 高潮次数 +1

### 高潮次数 (Orgasm Count)
- **上限**: 由战斗规则设定
- **效果**: 达到上限后进入"虚脱"状态
- **虚脱状态**: 当前耐力 -30%，无法有效抵抗
- **胜负判定**: 先达到指定高潮次数一方失败

## 经验与升级系统

### 升级需求
- **每级所需经验**: 100点（固定）
- **计算公式**: 升级到N级需要 (N-1) × 100 点经验

### 经验值获取

| 来源 | 经验值范围 | 说明 |
|------|-----------|------|
| 战斗中每轮对抗 | 10-20点 | 随机 |
| 性斗胜利 | 25 + (敌方等级 - 玩家等级) × 5 | 最低30点 |
| 性斗失败 | 10-25点 | 随机 |
| 调教中每次高潮 | 20-40点 | 随机 |
| 探索 | 5-15点 | 随机，有概率 |
| 观战和练习 | 10-30点 | 随机 |

### 升级效果
- **属性点获得**: 潜力 ÷ 2（向下取整）
- **可分配属性**: 魅力、幸运、最大耐力、最大快感、闪避率、暴击率

**示例**:
- 潜力 6.0 → 获得 3 点属性点
- 潜力 7.5 → 获得 3 点属性点
- 潜力 10.0 → 获得 5 点属性点

## 状态系统

### 贤者时间（临时状态）
- **触发**: 高潮后自动触发
- **持续时间**: 3回合
- **效果**:
  - 性斗力成算 -20%
  - 忍耐力成算 +10%

### 虚脱状态
- **触发**: 达到高潮次数上限
- **效果**: 当前耐力 -30%

## 使用示例

```typescript
import { 
  calculateSexualCombatPower, 
  calculateEndurance,
  extractCombatData 
} from './utils/combat-calculator';

// 从 MVU 数据中提取战斗数据
const mvuData = Mvu.getMvuData({ type: 'message', message_id: 'latest' });
const combatData = extractCombatData(mvuData);

// 计算性斗力
const sexPower = calculateSexualCombatPower(combatData, false);

// 计算忍耐力
const endurance = calculateEndurance(combatData, false, false);

// 检查是否触发高潮（使用变量中的最大快感值）
const maxLust = combatData.核心状态._最大快感;
if (combatData.核心状态._快感 >= maxLust) {
  const updates = handleOrgasm(combatData);
  // 更新 MVU 变量
}
```

## 注意事项

1. **性斗力和忍耐力是动态计算的**，不存储在 MVU 变量中
2. **$基础性斗力** 和 **$基础忍耐力** 字段仅用于显示，实际值由公式计算
3. **成算（百分比加成）** 是累加的，例如 30% + 20% = 50% = 1.5倍
4. **所有计算结果向下取整**，确保为整数
5. **经验值获取是随机的**，在指定范围内随机

